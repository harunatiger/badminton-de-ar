<% if @user.persisted? %>
  <% if session[:reservation_params].present? %>
    <% session[:reservation_params_after_sign_up] = session[:reservation_params] %>
    <% session[:reservation_params] = nil %>
    <% listing = Listing.find_by_id(session[:reservation_params_after_sign_up]['listing_id']) %>
    <% message_thread_id = GuestThread.get_message_thread_id(listing.try('user_id'), current_user.id) %>
    <% message_thread_id ? message_thread_path(message_thread_id) : root_path %>
    window.location.href = "<%=message_thread_id ? message_thread_path(message_thread_id) : root_path %>";
  <% elsif session[:previous_url].index('profiles') && !current_user.guest? %>
    <% session[:what_talk_about] = true unless current_user.main_guide? %>
    window.location.href = "<%=message_thread_path(DefaultThread.get_message_thread_id(session[:to_user_id], current_user.id)) %>";
  <% else %>
    <% session[:what_talk_about] = true %>
    window.location.href = "<%=message_thread_path(GuestThread.get_message_thread_id(session[:to_user_id], current_user.id)) %>";
  <% end %>
<% else %>
  $("#error_message").html($("<%=j render partial: 'shared/modals/error_message', locals: {target: @user} %>").hide().fadeIn("slow"));
<% end %>